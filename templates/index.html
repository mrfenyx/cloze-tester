<!doctype html>
<html lang="en">
  <head>
    <title>Cloze Test Generator</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; }
      textarea { width: 100%; height: 200px; }
      .result { margin-top: 2em; }
      .cloze { font-family: 'Courier New', Courier, monospace; }
      #input-section { transition: opacity 0.3s; }
      #original-input { 
        background: #f6f6f6; 
        border: 1px solid #ccc; 
        padding: 10px; 
        margin-top: 1em;
        display: none;
        white-space: pre-wrap;
      }
      .show-btn {
        margin: 1em 0;
        padding: 0.3em 1em;
        font-size: 1em;
        cursor: pointer;
      }
      .error {
        color: #a00;
        background: #ffeaea;
        padding: 0.8em;
        margin-bottom: 1em;
        border-radius: 5px;
        border: 1px solid #e2b1b1;
      }
      label { font-weight: bold; }
      .controls { margin-bottom: 1.5em; }
      .generated-note { color: #3a7f22; margin-bottom: 1em; }
    </style>
    <script>
      function showInput() {
        var el = document.getElementById('original-input');
        el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        document.getElementById('show-btn').innerText = el.style.display === 'none' ? 'Show Original Input' : 'Hide Original Input';
      }
    </script>
  </head>
  <body>
    {% if debug_log %}
    <div style="background:#f9f9e7; color:#444; border:1px solid #eed; margin-bottom:1em; padding:0.7em;">
        <b>Debug log:</b><br>
        <pre style="white-space: pre-wrap;">{{ debug_log|join('\n') }}</pre>
    </div>
    {% endif %}

    <h1>Cloze Test Generator</h1>
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    {% if not result %}
      <div id="input-section">
        <form method="post">
          <div class="controls">
            <label for="subject">Subject:</label>
            <input type="text" name="subject" id="subject" value="{{ subject or '' }}" required>
            &nbsp;
            <label for="level">CEFR Level:</label>
            <select name="level" id="level" required>
              {% for l in ["A1","A2","B1","B2","C1","C2"] %}
                <option value="{{l}}" {% if level == l %}selected{% endif %}>{{l}}</option>
              {% endfor %}
            </select>
            <button type="submit" name="generate">Generate with DeepSeek</button>
          </div>
          <label for="input_text">Or paste/edit your GPT-generated text (use [[word]] to mark blanks):</label><br>
          <textarea name="input_text" id="input_text">{{ input_text }}</textarea><br><br>
          <button type="submit" name="submit">Generate Cloze Test</button>
        </form>
      </div>
    {% else %}
      {% if subject and request.form.get('generate') %}
        <div class="generated-note">Text was generated by DeepSeek.</div>
      {% endif %}
      <button id="show-btn" class="show-btn" onclick="showInput()">Show Original Input</button>
      <div id="original-input">{{ input_text }}</div>
      <div class="result">
        <h2>Your Cloze Test:</h2>
        <ol>
          {% for sentence in result %}
            <li class="cloze">{{ sentence }}</li>
          {% endfor %}
        </ol>
        <br>
        <a href="/">&#8592; Create another test</a>
      </div>
    {% endif %}
  </body>
</html>
